{% extends 'base.html' %}

{% block title %}{% if purchase %}Edit{% else %}New{% endif %} Purchase - School Inventory Management System{% endblock %}
{% block page_title %}{% if purchase %}Edit Purchase{% else %}New Purchase{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">Purchase Details</div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="supplier" class="form-label">Supplier *</label>
                        <select class="form-control" id="supplier" name="supplier" required>
                            <option value="">Select Supplier</option>
                            {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" {% if purchase.supplier.id == supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Items</label>
                        <div id="itemsContainer"></div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addItemRow()">Add Item</button>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taxAmount" class="form-label">Tax Amount</label>
                                <input type="number" class="form-control" id="taxAmount" name="tax_amount" step="0.01" value="{{ purchase.tax_amount|default:0 }}">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3">{{ purchase.notes|default:'' }}</textarea>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Purchase</button>
                        <a href="{% url 'purchase_list' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const items = {{ items|safe }};
    let itemCount = 0;

    function addItemRow() {
        const container = document.getElementById('itemsContainer');
        const row = document.createElement('div');
        row.className = 'row mb-2 item-row';
        row.innerHTML = `
            <div class="col-md-5">
                <select class="form-control" name="item_id" required>
                    <option value="">Select Item</option>
                    ${items.map(item => `<option value="${item.id}">${item.name} (${item.sku})</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="quantity" placeholder="Qty" min="1" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="unit_cost" placeholder="Cost" step="0.01" min="0" required>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">Remove</button>
            </div>
        `;
        container.appendChild(row);
    }

    // Add initial row
    addItemRow();
</script>
{% endblock %}
