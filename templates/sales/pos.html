{% extends 'base.html' %}

{% block title %}POS System - School Inventory Management System{% endblock %}
{% block page_title %}Point of Sale (POS) System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">Search Products</div>
            <div class="card-body">
                <input type="text" id="productSearch" class="form-control" placeholder="Search by product name or SKU...">
                <div id="productList" class="mt-3"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Shopping Cart</div>
            <div class="card-body">
                <form id="saleForm" method="post" action="{% url 'create_sale' %}">
                    {% csrf_token %}
                    <div id="cartItems"></div>
                    <hr>
                    <div class="mb-3">
                        <label for="taxAmount" class="form-label">Tax Amount</label>
                        <input type="number" class="form-control" id="taxAmount" name="tax_amount" step="0.01" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="discountAmount" class="form-label">Discount Amount</label>
                        <input type="number" class="form-control" id="discountAmount" name="discount_amount" step="0.01" value="0">
                    </div>
                    <div class="mb-3">
                        <h5>Total: $<span id="totalAmount">0.00</span></h5>
                    </div>
                    <button type="submit" class="btn btn-success w-100"><i class="fas fa-check"></i> Complete Sale</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const items = {{ items|safe }};
    let cart = {};

    document.getElementById('productSearch').addEventListener('keyup', function(e) {
        const query = e.target.value.toLowerCase();
        const productList = document.getElementById('productList');
        productList.innerHTML = '';

        items.forEach(item => {
            if (item.name.toLowerCase().includes(query) || item.sku.toLowerCase().includes(query)) {
                const div = document.createElement('div');
                div.className = 'card mb-2';
                div.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.name}</strong><br>
                                <small>SKU: ${item.sku} | Stock: ${item.quantity} | Price: $${item.unit_price}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addToCart(${item.id}, '${item.name}', ${item.unit_price}, ${item.quantity})">Add</button>
                        </div>
                    </div>
                `;
                productList.appendChild(div);
            }
        });
    });

    function addToCart(itemId, name, price, maxQty) {
        if (!cart[itemId]) {
            cart[itemId] = { name, price, quantity: 0, maxQty };
        }
        if (cart[itemId].quantity < maxQty) {
            cart[itemId].quantity++;
            updateCart();
        }
    }

    function removeFromCart(itemId) {
        delete cart[itemId];
        updateCart();
    }

    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        cartItems.innerHTML = '';
        let total = 0;

        Object.entries(cart).forEach(([itemId, item]) => {
            const subtotal = item.quantity * item.price;
            total += subtotal;

            const div = document.createElement('div');
            div.className = 'mb-2 p-2 border rounded';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>$${item.price} x ${item.quantity} = $${subtotal.toFixed(2)}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeFromCart(${itemId})">Remove</button>
                </div>
                <input type="hidden" name="item_id" value="${itemId}">
                <input type="hidden" name="quantity" value="${item.quantity}">
            `;
            cartItems.appendChild(div);
        });

        const tax = parseFloat(document.getElementById('taxAmount').value) || 0;
        const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
        const finalTotal = total + tax - discount;
        document.getElementById('totalAmount').textContent = finalTotal.toFixed(2);
    }

    document.getElementById('taxAmount').addEventListener('change', updateCart);
    document.getElementById('discountAmount').addEventListener('change', updateCart);
</script>
{% endblock %}
